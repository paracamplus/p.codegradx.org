function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var t=e(require("query-string"));const n=["./secrets/","/run/secrets/"],r="fkeyPrivate";function o(e=r){return function(e,t){let r;if(process.env[t.toUpperCase()])r=process.env[t.toUpperCase()],r=r.replace(/@/g,"\n");else{const e=require("fs");try{for(const o of n){const n=`${o}/${t}`;if(e.existsSync(n)){r=e.readFileSync(n);break}}}catch(e){throw e}}if(!r)throw new Error(`Missing key ${t}`);try{return e({key:r,format:"pem"})}catch(e){throw e}}(require("crypto").createPrivateKey,e)}const s=require("fs");function i(e){let t="";try{t+=`\nContent of directory ${e}/:\n  `,t+=s.readdirSync(e).join(",\n  ")}catch(n){t+=`!!!!! Absent directory ${e}`}return t+="\n",t}const c=["static/_digits","./export/_digits","./static/_digits"];module.exports=function(e,t=5e3){return async function(n,r,o){try{return new Promise(((o,s)=>{setTimeout((()=>s("timeout")),t),o(e(n,r))}))}catch(e){return{statusCode:500,headers:{},body:r.body+e.toString()}}}}((async function(e,n,r){try{const r=e.url.replace(/^.*\?/,"?");let f=t.default.parse(r).slug.replace(/[.]png$/,""),a="";a+=i(process.cwd()),a+=i("./api"),a+=i("./export"),a+=i("./static"),console.log(a);let u=[];const l=function(e){let t=new Map,n=e.headers.cookie;if(n){n=n.split(";");for(const e of n){const n=e.trim().split("=");t.set(n[0],decodeURIComponent(n[1]))}}return t}(e).get("MV");if(!l)throw"Missing MV cookie";u=function(e){const t=require("crypto"),n=o();let r=[];const s=e.split(",");function i(e){let o=decodeURIComponent(e);o=Buffer.from(o,"base64"),o=t.privateDecrypt(n,o),r.push(o.toString())}for(let e of s)i(e);return r.join("")}(l).split(",").slice(2);let p;for(const e of c){const t=`${e}/bad.png`;if(s.existsSync(t)){p=t;break}}if(!p)throw"Missing bad png";for(const e of c)if(u.length>0)for(let t=0;t<u.length;t++)if(u[t]===f){const n=`${e}/${t}.png`;if(s.existsSync(n)){p=n;break}}console.log(`Sending pngfile ${p}`),n.setHeader("Content-Type","image/png"),n.end(s.readFileSync(p))}catch(e){console.log(e),n.status(400),n.end(JSON.stringify({error:e.toString()}))}}));
