function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var t=e(require("query-string"));const s=["./secrets/","/run/secrets/"],o="fkeyPrivate";function r(e=o){return function(e,t){let o;if(process.env[t.toUpperCase()])o=process.env[t.toUpperCase()],o=o.replace(/@/g,"\n");else{const e=require("fs");try{for(const r of s){const s=`${r}/${t}`;if(e.existsSync(s)){o=e.readFileSync(s);break}}}catch(e){throw e}}if(!o)throw new Error(`Missing key ${t}`);try{return e({key:o,format:"pem"})}catch(e){throw e}}(require("crypto").createPrivateKey,e)}function n(e){const t=require("crypto"),s=r();let o=[];const n=e.split(",");function i(e){let r=decodeURIComponent(e);r=Buffer.from(r,"base64"),r=t.privateDecrypt(s,r),o.push(r.toString())}for(let e of n)i(e);return o.join("")}const i=require("fs");class c{constructor(e){this.request=e,this.url=e.url,this.query=e.query,this.cookies=[];let t="";Object.keys(e.cookies).forEach((s=>{const o=`${s}=${encodeURIComponent(e.cookies[s])}`;t+=`${o};`,this.cookies.push(o)})),this.headers={cookie:t}}}class a{constructor(e){this.statusCode=500,this.response=e,this.statusMessage="Server problem",this.body="",this["Content-Type"]="application/json"}setHeader(e,t){this.response.setHeader(e,t)}statusMessage(e){console.log(`ignore statusMessage(${e})`)}statusCode(e){this.response.status(e)}end(e){this.response.send(e)}}module.exports=function(e,t=5e3){return async function(s,o,r){try{const r=new c(s),n=new a(o);return new Promise(((s,o)=>{setTimeout((()=>o("timeout")),t),s(e(r,n))}))}catch(e){return{statusCode:500,headers:{},body:o.body+e.toString()}}}}((async function(e,s,o){let r=e.query||t.default.parse(e.url);console.log(e.url,e.query);let c=r.slug;c=c.replace(/[.]png$/,"");let a=[];const u=e.cookies||e.headers.cookie.split(";");console.log("cookies",u);for(const e of u){const t=e.trim().split("="),s=n(t[1]);if("MV"===t[0]){a=s.split(",").slice(2);break}}let l="static/_digits/bad.png";if(a.length>0)for(let e=0;e<a.length;e++)if(a[e]===c){l=`static/_digits/${e}.png`;break}s.setHeader("Content-Type","image/png"),s.end(i.readFileSync(l))}));
