function e(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var t=e(require("query-string"));const r=["./secrets/","/run/secrets/"],n="fkeyPrivate";function o(e=n){return function(e,t){let n;if(process.env[t.toUpperCase()])n=process.env[t.toUpperCase()],n=n.replace(/@/g,"\n");else{const e=require("fs");try{for(const o of r){const r=`${o}/${t}`;if(e.existsSync(r)){n=e.readFileSync(r);break}}}catch(e){throw e}}if(!n)throw new Error(`Missing key ${t}`);try{return e({key:n,format:"pem"})}catch(e){throw e}}(require("crypto").createPrivateKey,e)}const s=require("fs"),i=["static/_digits","../_digits"];module.exports=function(e,t=5e3){return async function(r,n,o){try{return new Promise(((o,s)=>{setTimeout((()=>s("timeout")),t),o(e(r,n))}))}catch(e){return{statusCode:500,headers:{},body:n.body+e.toString()}}}}((async function(e,r,n){try{const n=e.url.replace(/^.*\?/,"?");let c=t.default.parse(n).slug.replace(/[.]png$/,""),f=[];const a=function(e){let t=new Map,r=e.headers.cookie;if(r){r=r.split(";");for(const e of r){const r=e.trim().split("=");t.set(r[0],decodeURIComponent(r[1]))}}return t}(e).get("MV");if(!a)throw"Missing MV cookie";f=function(e){const t=require("crypto"),r=o();let n=[];const s=e.split(",");function i(e){let o=decodeURIComponent(e);o=Buffer.from(o,"base64"),o=t.privateDecrypt(r,o),n.push(o.toString())}for(let e of s)i(e);return n.join("")}(a).split(",").slice(2);let u;for(const e of i){const t=`${e}/bad.png`;if(s.existsSync(t)){u=t;break}}if(!u)throw"Missing bad png";for(const e of i)if(f.length>0)for(let t=0;t<f.length;t++)if(f[t]===c){const r=`${e}/${t}.png`;if(s.existsSync(r)){u=r;break}}r.setHeader("Content-Type","image/png"),r.end(s.readFileSync(u))}catch(e){console.log(e),r.status(400),r.end(JSON.stringify({error:e.toString()}))}}));
