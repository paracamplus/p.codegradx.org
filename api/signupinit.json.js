var e=require("codegradx");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=t(require("node-fetch"));const o=["./secrets/","/run/secrets/"],r="fkeyPublic";function i(e=r){return function(e,t){let n;if(process.env[t.toUpperCase()])n=process.env[t.toUpperCase()],n=n.replace(/@/g,"\n");else{const e=require("fs");try{for(const r of o){const o=`${r}/${t}`;if(e.existsSync(o)){n=e.readFileSync(o);break}}}catch(e){throw e}}if(!n)throw new Error(`Missing key ${t}`);try{return e({key:n,format:"pem"})}catch(e){throw e}}(require("crypto").createPublicKey,e)}module.exports=function(e,t=5e3){return async function(n,o,r){try{return new Promise(((r,i)=>{setTimeout((()=>i("timeout")),t),r(e(n,o))}))}catch(e){return{statusCode:500,headers:{},body:o.body+e.toString()}}}}((async function(t,o,r){const s=new e.CodeGradX.State;s.servers=s.defaultservers,s.fetch=n.default,s.sendAXServer("x",{path:"/movecaptchainfo",method:"GET",headers:{Accept:"application/json"}}).then((t=>{if("JSON"!==t.entityKind)throw"bad answer";const n=t.entity.nonce,r=t.entity.wanted,s=e.CodeGradX._str2Date(t.entity.expires).toUTCString(),c=t.entity.images,a=function(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1)),o=e[n];e[n]=e[t],e[t]=o}return e}(c.map((e=>`/api/digit?slug=${e}`)));let u=`${n},${r.join("")},${c.join(",")}`;u=function(e){const t=require("crypto");let n=[];const o=i();function r(e){let r=t.publicEncrypt(o,Buffer.from(e));r=r.toString("base64"),r=encodeURIComponent(r),n.push(r)}for(;e.length>0;)r(e.slice(0,80)),e=e.slice(80);return n.join(",")}(u);let p=`MV=${u}; path=/api; expires=${s};`;p+="sameSite=none; secure; httponly;",o.setHeader("Set-Cookie",p),o.setHeader("Content-Type","application/json"),o.end(JSON.stringify({nonce:n,wanted:r,urls:a,expires:s}))})).catch((e=>{console.log("signupinit PB",s.log),console.log("signupinit PB",{exc:e});let t=`Problem\nexception: ${e.toString()}\nstate.log is\n${s.log.items.join("\n")}\n`;o.statusCode=500,o.statusMessage="Erroneous movecaptchainfo",o.setHeader("Content-Type","text/plain"),o.end(t)}))}));
